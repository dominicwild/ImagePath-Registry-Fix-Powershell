$services = Get-ChildItem -path HKLM:\SYSTEM\CurrentControlSet\Services

$fileString = (Get-Date -Format FileDateTimeUniversal).ToString() + "" + (Get-Random).toString() + ".log" 

function fixPath([string]$path){
    $path = $path.trim()
    if(!($path[0] -eq '"' -and $path[$path.Length-1] -eq '"')){
        Write-Host "Original Path:" $path
        $path = '"' + $path + '"' 
        Write-Host "Path corrected:" $path
    }
    $path
}

function border(){
    Write-Host "================="
}

$imagePathServices = @()

$services | ForEach-Object {
    if($_.GetValueNames() -contains "ImagePath"){
        $imagePathServices += $_
    }
}


foreach($service in $imagePathServices){

    $imagePath = Get-ItemPropertyValue -path $service.pspath -Name ImagePath
    
    Select-String -Pattern '(.* .*\.[\w"]+)(.*)' -InputObject $imagePath |
        Foreach-Object {
            $path, $args = $_.Matches[0].Groups[1..2].Value
            Write-Host "Processing:" $path
            $fixedPath = fixPath($path)
            $imagePath = $path + $args

            if($fixedPath -ne $path){

                $imagePath = $fixedPath + $args
                    
                Set-ItemProperty -path $service.pspath -Name ImagePath -Value $imagePath
                $date = Get-Date
                $logData = "[" + $date + "]" + "`n Service: " + $service.pspath + "`n Original Path: " + $path + "`n Changed to: " + $fixedPath
                Add-Content -Path $fileString -Value $logData

                Write-Host $logData
            }
        }
}

